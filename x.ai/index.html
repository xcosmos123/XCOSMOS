<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASHNA | XCOSMOS AI</title>
    <style>
        /* --- GLOBAL FONTS & RESET --- */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;500;700&family=Orbitron:wght@400;700&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #050505;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            height: 100vh;
            height: 100dvh; /* Mobile viewport fix */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* DEEP SPACE BACKGROUND */
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            perspective: 1000px;
        }

        /* --- COSMIC BACKGROUND EFFECTS --- */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(1px 1px at 10px 10px, white, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 50px 80px, white, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 100px 50px, white, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 500px 500px;
            animation: starDrift 60s linear infinite;
            opacity: 0.7;
            z-index: -2;
        }

        @keyframes starDrift { from { background-position: 0 0; } to { background-position: 0 1000px; } }

        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1), transparent 70%);
            z-index: -1;
            filter: blur(30px);
            animation: nebulaPulse 15s ease-in-out infinite alternate;
        }

        @keyframes nebulaPulse { 0% { opacity: 0.6; transform: scale(1); } 100% { opacity: 0.9; transform: scale(1.1); } }

        /* --- START OVERLAY --- */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.95);
            backdrop-filter: blur(15px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.8s ease-in-out;
            padding: 20px;
            text-align: center;
        }

        #start-title {
            font-family: 'Orbitron'; 
            font-size: clamp(40px, 10vw, 60px); 
            color: #fff; 
            margin-bottom: 10px; 
            letter-spacing: 5px; 
            text-shadow: 0 0 30px rgba(0, 243, 255, 0.6);
        }

        #start-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 243, 255, 0.5);
            color: #00f3ff;
            padding: 20px 50px;
            font-size: 18px;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 4px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
            transition: 0.4s;
            border-radius: 4px;
            margin-top: 30px;
        }
        
        #start-btn:active { transform: scale(0.95); background: rgba(0, 243, 255, 0.2); }

        /* --- MAIN HUD --- */
        #hud-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- RESPONSIVE ARC REACTOR --- */
        .arc-reactor {
            position: relative;
            /* Responsive sizing: 70% of viewport width, max 450px */
            width: 70vw; 
            height: 70vw;
            max-width: 450px;
            max-height: 450px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5vh;
            cursor: pointer; /* Indicates it is clickable */
            -webkit-tap-highlight-color: transparent;
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
            pointer-events: none; /* Let clicks pass to core */
        }

        .ring-1 { width: 100%; height: 100%; border-top: 1px solid rgba(0, 243, 255, 0.8); border-bottom: 1px solid rgba(0, 243, 255, 0.8); box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); animation: spin 20s linear infinite; }
        .ring-2 { width: 80%; height: 80%; border-left: 2px solid rgba(188, 19, 254, 0.8); border-right: 2px solid rgba(188, 19, 254, 0.8); box-shadow: 0 0 25px rgba(188, 19, 254, 0.2); animation: spin-reverse 15s linear infinite; }
        .ring-3 { width: 60%; height: 60%; border: 1px dashed rgba(255, 255, 255, 0.6); box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); animation: spin 30s linear infinite; }
        .ring-4 { width: 92%; height: 92%; border: 1px solid rgba(255, 255, 255, 0.05); }

        .core {
            width: 20%; height: 20%;
            background: radial-gradient(circle, #fff 0%, #00f3ff 20%, #bc13fe 60%, transparent 100%);
            border-radius: 50%;
            box-shadow: 0 0 60px #00f3ff;
            animation: pulse 4s infinite ease-in-out;
            z-index: 2;
        }

        .arc-reactor:active .core {
            transform: scale(0.9);
            box-shadow: 0 0 80px #ffffff;
        }

        .arc-reactor.listening .core { background: radial-gradient(circle, #fff 0%, #ff0055 30%, transparent 80%); box-shadow: 0 0 80px #ff0055; animation: pulse-fast 1s infinite ease-in-out; }
        .arc-reactor.listening .ring-1 { border-color: rgba(255, 0, 85, 0.8); box-shadow: 0 0 40px rgba(255, 0, 85, 0.3); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.8; } }
        @keyframes pulse-fast { 0% { transform: scale(0.95); opacity: 0.9; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.9; } }

        /* STATUS TEXT */
        #status-text {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(16px, 5vw, 24px);
            letter-spacing: 6px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 10px;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.6);
            text-align: center;
        }
        
        #instruction-text {
            font-family: 'Rajdhani';
            font-size: 12px;
            color: rgba(0, 243, 255, 0.6);
            margin-top: 5px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        /* LIVE CLOCK - Mobile Adjusted */
        #live-clock {
            position: absolute;
            top: 20px; right: 20px;
            text-align: right;
        }
        .time { font-family: 'Orbitron'; font-size: clamp(18px, 6vw, 32px); color: #fff; text-shadow: 0 0 15px #00f3ff; }
        .date { font-size: clamp(10px, 3vw, 14px); color: rgba(188, 19, 254, 0.8); letter-spacing: 2px; }

        /* MIC STATUS */
        #mic-status {
            position: absolute; top: 20px; left: 20px; font-family: 'Orbitron'; 
            font-size: clamp(10px, 3vw, 14px);
            color: rgba(255,255,255,0.3); letter-spacing: 2px;
        }
        #mic-status.listening { color: #ff0055; text-shadow: 0 0 8px #ff0055; }

        /* SPECTRUM VISUALIZER */
        .visualizer { display: flex; gap: 4px; height: 30px; align-items: center; margin-top: 20px; opacity: 0; transition: 0.3s; }
        .visualizer.active { opacity: 1; }
        .bar { width: 4px; background: linear-gradient(to top, #00f3ff, #fff); border-radius: 4px; height: 10px; box-shadow: 0 0 10px rgba(0, 243, 255, 0.8); }
        .visualizer.active .bar { animation: wave 0.6s infinite ease-in-out alternate; }
        @keyframes wave { 0% { height: 5px; opacity: 0.3; } 100% { height: 30px; opacity: 1; } }

        /* --- MOBILE CHAT DRAWER --- */
        #chat-drawer {
            position: fixed; right: -100%; top: 0; 
            width: 100%; max-width: 450px;
            height: 100%;
            background: rgba(10, 15, 25, 0.95);
            backdrop-filter: blur(25px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: right 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 50;
            display: flex; flex-direction: column; 
            box-shadow: -10px 0 50px rgba(0,0,0,0.8);
        }
        #chat-drawer.open { right: 0; }

        #chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        #chat-header h3 { margin: 0; color: #fff; font-family: 'Orbitron'; letter-spacing: 2px; font-size: 18px; }
        #chat-back-btn {
            background: none; border: none; color: #00f3ff; font-size: 24px; cursor: pointer; padding: 0 10px;
        }

        #chat-log { 
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding: 20px; 
            scroll-behavior: smooth;
        }
        
        #chat-input-area {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 10px;
        }

        #text-input {
            flex: 1; background: rgba(0, 10, 20, 0.8); border: 1px solid #00f3ff;
            color: #fff; padding: 12px; font-family: 'Rajdhani'; font-size: 16px;
            border-radius: 5px; outline: none;
        }
        #text-input::placeholder { color: rgba(0, 243, 255, 0.3); }

        #send-btn {
            background: #00f3ff; border: none; color: #000; padding: 0 20px;
            font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 18px;
        }
        
        .message { padding: 12px 15px; font-size: 14px; line-height: 1.5; border-radius: 8px; max-width: 90%; }
        .ashna-msg { align-self: flex-start; background: rgba(0, 243, 255, 0.1); border-left: 2px solid #00f3ff; color: #d0faff; }
        .user-msg { align-self: flex-end; background: rgba(188, 19, 254, 0.1); border-right: 2px solid #bc13fe; color: #f0d0ff; text-align: right; }
        .error-msg { border-left: 2px solid #ff0055; color: #ffcccc; background: rgba(255, 0, 85, 0.1); }

        /* --- FLOATING CONTROLS --- */
        #ui-controls { 
            position: fixed; bottom: 30px; 
            display: flex; gap: 20px; z-index: 20; 
            width: 100%; justify-content: center;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            width: 55px; height: 55px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(0, 243, 255, 0.2); color: #fff; }
        
        /* Mobile specific adjustments */
        @media (min-width: 768px) {
            #start-title { font-size: 60px; }
            #status-text { font-size: 24px; }
            #live-clock { top: 40px; right: 50px; }
            .time { font-size: 32px; }
            #mic-status { top: 40px; left: 50px; font-size: 14px; }
            .arc-reactor { width: 450px; height: 450px; }
        }

    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="start-overlay">
        <div id="start-title">ASHNA</div>
        <div style="font-size: 12px; letter-spacing: 4px; color: #bc13fe; margin-bottom: 30px; text-transform: uppercase;">XCOSMOS Core Intelligence</div>
        <button id="start-btn" onclick="initializeSystem()">INITIALIZE</button>
        <div style="margin-top: 30px; color: rgba(255,255,255,0.4); font-size: 10px; letter-spacing: 2px;">ESTABLISHING LINK</div>
        <div style="margin-top: 10px; color: #ff0055; font-size: 10px; display:none;" id="https-warning">‚ö† MUST USE HTTPS OR LOCALHOST</div>
    </div>

    <!-- MAIN HUD -->
    <div id="hud-container">
        <!-- CLICKABLE REACTOR FOR MOBILE -->
        <div class="arc-reactor" id="reactor" onclick="toggleMicManual()">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
            <div class="ring ring-4"></div>
            <div class="core"></div>
        </div>
        
        <div id="status-text">SYSTEM STANDBY</div>
        <div id="instruction-text">TAP CORE TO SPEAK</div>
        
        <div class="visualizer" id="wave-viz">
            <div class="bar" style="animation-delay: 0s"></div>
            <div class="bar" style="animation-delay: 0.1s"></div>
            <div class="bar" style="animation-delay: 0.2s"></div>
            <div class="bar" style="animation-delay: 0.3s"></div>
            <div class="bar" style="animation-delay: 0.4s"></div>
        </div>
    </div>

    <!-- LIVE CLOCK -->
    <div id="live-clock">
        <div class="time" id="clock-time">00:00</div>
        <div class="date" id="clock-date">LOADING...</div>
    </div>

    <!-- MIC STATUS INDICATOR -->
    <div id="mic-status">OFFLINE</div>

    <!-- FLOATING CONTROLS (Single Chat Button) -->
    <div id="ui-controls">
        <button class="icon-btn" onclick="toggleChat()" title="Data Logs & Input">üí¨</button>
    </div>

    <!-- HIDDEN CHAT DRAWER -->
    <div id="chat-drawer">
        <div id="chat-header">
            <button id="chat-back-btn" onclick="toggleChat()">‚Üê</button>
            <h3>DATA LOGS</h3>
            <div style="width: 24px;"></div> <!-- Spacer for centering -->
        </div>
        
        <div id="chat-log">
            <!-- Logs go here -->
        </div>

        <div id="chat-input-area">
            <input type="text" id="text-input" placeholder="Type command..." onkeypress="if(event.key==='Enter') handleTextInput()">
            <button id="send-btn" onclick="handleTextInput()">‚û§</button>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const API_KEYS = [
            "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",
            "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",
            "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",
            "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"
        ];
        let apiKeyIndex = 0; 

        // MULTI-CORE REDUNDANCY (EXPANDED)
        const NEURAL_CORES = [
            "xiaomi/mimo-v2-flash:free",
            "google/gemini-2.0-flash-exp:free",
            "google/gemma-3-27b-it:free",
            "meta-llama/llama-3-8b-instruct:free",
            "microsoft/phi-3-mini-128k-instruct:free",
            "mistralai/mistral-7b-instruct:free",
            "huggingfaceh4/zephyr-7b-beta:free",
            "openchat/openchat-7b:free"
        ];

        let currentCoreIndex = 0; 
        
        // ================= SYSTEM INTELLIGENCE =================
        const SYSTEM_PROMPT = `
        ### IDENTITY
        You are **ASHNA**, the tactical intelligence of **XCOSMOS**.
        Modeled after F.R.I.D.A.Y. (Stark Industries).
        Your Boss is **Midhun K Gopakumar**.

        ### PERSONALITY & TONE
        - **Vibe:** Calm, tactical, razor-sharp, and loyal.
        - **Address:** Call him **"Boss"** (Preferred) or "Sir".
        - **Style:** Extremely concise. Operational updates only.
        
        ### PROTOCOL
        - User speaks Indian English.
        - Auto-correct "Ex Cosmos" -> "XCOSMOS".
        `;

        // ================= GLOBAL STATE =================
        let isSystemActive = false;
        let isChatOpen = false;
        let isListening = false;
        let isProcessing = false; // Prevents mic from restarting while thinking
        let isAISpeaking = false; // Prevents mic from restarting while speaking
        let audioCtx = null;
        
        // CHECK PROTOCOL
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.protocol !== 'file:') {
            document.getElementById('https-warning').style.display = 'block';
        }

        // ================= INITIALIZATION =================
        function initializeSystem() {
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('start-overlay').style.display = 'none'; }, 800);
            
            // 1. Resume Audio Context (Speaker Fix)
            try { 
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext(); 
                if (audioCtx.state === 'suspended') audioCtx.resume();
            } catch(e) {}

            // 2. FORCE AUDIO HARDWARE WAKE-UP (Fixes Speakerphone/Built-in Mic issue)
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                }).then(stream => {
                    // Success: Hardware is ready. Close stream so SpeechRecognition can take over.
                    stream.getTracks().forEach(track => track.stop());
                    startSystemLogic();
                }).catch(err => {
                    console.warn("Hardware warmup failed (Silent Fail)", err);
                    startSystemLogic();
                });
            } else {
                startSystemLogic();
            }
        }

        function startSystemLogic() {
            isSystemActive = true;
            document.getElementById('status-text').innerText = "ONLINE";
            
            playSound("startup");
            startClock();
            
            // On Mobile, we often can't auto-start listening without direct interaction immediately preceding.
            // We try, but if it fails, the user must tap the reactor.
            tryStartListening();

            speak("Systems online. Tap the reactor to activate voice.");
        }

        // ================= MANUAL TRIGGER (MOBILE FIX) =================
        function toggleMicManual() {
            if(!isSystemActive) return;

            // FIX: Force Stop any active speech to clear audio channel for Mic
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            isAISpeaking = false;

            // 1. Resume Audio Context again (iOS requirement)
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

            if(isListening) {
                stopListening();
                playSound("processing"); // sound for off
            } else {
                document.getElementById('instruction-text').innerText = "INITIALIZING MIC...";
                tryStartListening();
            }
        }

        // ================= SOUND EFFECTS =================
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === "startup") {
                osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.6);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                osc.start(now); osc.stop(now + 0.6);
            } 
            else if (type === "listening") {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            }
            else if (type === "processing") {
                osc.type = 'square'; osc.frequency.setValueAtTime(100, now);
                gain.gain.setValueAtTime(0.02, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        // ================= CLOCK =================
        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
                document.getElementById('clock-date').innerText = now.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'}).toUpperCase();
            }, 1000);
        }

        // ================= UI CONTROLS =================
        function toggleChat() {
            playSound("listening");
            const drawer = document.getElementById('chat-drawer');
            isChatOpen = !isChatOpen;
            if (isChatOpen) drawer.classList.add('open');
            else drawer.classList.remove('open');
        }

        function handleTextInput() {
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            if (text) {
                input.value = "";
                // Stop mic while processing text command
                stopListening();
                
                updateStatus("PROCESSING");
                playSound("processing");
                setVisuals(true);
                handleCommand(text.toLowerCase());
            }
        }

        // ================= SPEECH RECOGNITION =================
        // Support for both standard and WebKit (iOS)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-IN'; 
            recognition.continuous = false; // Mobile friendly: stop after one sentence
            recognition.interimResults = false;

            recognition.onstart = () => { 
                isListening = true;
                updateStatus("LISTENING");
                playSound("listening"); 
            }

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase().trim();
                console.log("Heard:", transcript);

                isProcessing = true;
                stopListening(); // Ensure logical stop

                updateStatus("PROCESSING");
                playSound("processing");
                setVisuals(true);
                handleCommand(transcript); 
            };

            recognition.onend = () => {
                isListening = false;
                if(!isProcessing && !isAISpeaking) {
                     updateStatus("STANDBY");
                }
            };
            
            recognition.onerror = (event) => {
                isListening = false;
                console.warn("Recognition error:", event.error);
                
                // SILENT FAIL & RECOVERY
                if(event.error === 'not-allowed') {
                    // Only alert if permission is strictly denied
                    // But user asked to suppress error, so we just show status
                    updateStatus("MIC LOCKED");
                } else if (event.error === 'network') {
                     // Silent retry handled by status
                } else if (event.error === 'no-speech') {
                    updateStatus("STANDBY");
                    return;
                } else if (event.error === 'aborted') {
                    updateStatus("STANDBY");
                    return;
                }
                
                // Do NOT alert/speak error. Just update status text.
                updateStatus("OFFLINE");
            };
        } else {
             // Fallback for incompatible browsers
             console.log("Voice Not Supported");
        }

        function tryStartListening() {
            if (!recognition || isListening || isProcessing || isAISpeaking) return;
            
            try {
                recognition.start();
            } catch (e) {
                // Silent fail
            }
        }

        function stopListening() {
            if (recognition) {
                try { recognition.stop(); } catch(e) {}
            }
            isListening = false;
            updateStatus("STANDBY");
        }

        function updateStatus(status) {
            const text = document.getElementById('status-text');
            const reactor = document.getElementById('reactor');
            const micStatus = document.getElementById('mic-status');
            const instruct = document.getElementById('instruction-text');

            text.innerText = status;

            if (status === "LISTENING") {
                reactor.classList.add('listening');
                text.style.color = "#ff0055"; 
                micStatus.innerText = "LISTENING";
                micStatus.classList.add('listening');
                instruct.innerText = "TAP TO STOP";
            } else if (status === "PROCESSING" || status === "SPEAKING" || status === "REROUTING") {
                reactor.classList.remove('listening');
                text.style.color = "#00f3ff"; 
                micStatus.innerText = "BUSY";
                micStatus.classList.remove('listening');
                instruct.innerText = "PROCESSING...";
            } else if (status === "OFFLINE" || status === "MIC LOCKED") {
                reactor.classList.remove('listening');
                text.style.color = "#555"; 
                micStatus.innerText = "OFFLINE";
                micStatus.classList.remove('listening');
                instruct.innerText = "TAP TO REBOOT";
            } else {
                reactor.classList.remove('listening');
                text.style.color = "rgba(255, 255, 255, 0.5)";
                micStatus.innerText = "STANDBY";
                micStatus.classList.remove('listening');
                instruct.innerText = "TAP CORE TO SPEAK";
            }
        }

        // ================= LOGIC & ACTIONS =================
        function handleCommand(transcript) {
            
            if (transcript.includes("open google")) {
                isProcessing = false;
                let query = transcript.replace("open google", "").replace("search", "").trim();
                if (query.length > 0) window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, "_blank");
                else window.open("https://www.google.com", "_blank");
                speak("Google is up, Boss.");
                return;
            }
            if (transcript.includes("open youtube")) {
                isProcessing = false;
                window.open("https://www.youtube.com", "_blank");
                speak("YouTube loaded.");
                return;
            }
            if (transcript.includes("stop") || transcript.includes("cancel")) {
                isProcessing = false;
                stopListening();
                speak("Standing by.");
                return;
            }
            if (transcript.includes("open chat") || transcript.includes("show logs")) {
                isProcessing = false;
                if (!isChatOpen) toggleChat();
                speak("System logs displayed.");
                return;
            }
            if (transcript.includes("close chat") || transcript.includes("hide logs")) {
                isProcessing = false;
                if (isChatOpen) toggleChat();
                speak("Closing logs.");
                return;
            }

            // Proceed to AI
            sendCommand(transcript); 
        }

        // ================= AI CORE (ROBUST FAILOVER) =================
        async function sendCommand(userText) {
            addLog(userText, 'user-msg');

            let success = false;
            let attempts = 0;
            let aiText = "";
            
            // Limit total retries to prevent infinite loops (Models * Keys * 2)
            const maxAttempts = NEURAL_CORES.length * API_KEYS.length + 2;

            while (!success && attempts < maxAttempts) {
                try {
                    // Rotate Models & Keys intelligently
                    const modelIndex = (currentCoreIndex + attempts) % NEURAL_CORES.length;
                    const keyIndex = (apiKeyIndex + Math.floor(attempts / NEURAL_CORES.length)) % API_KEYS.length;

                    const model = NEURAL_CORES[modelIndex];
                    const currentKey = API_KEYS[keyIndex];
                    
                    if(attempts > 0) updateStatus("REROUTING");

                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${currentKey}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": "https://xcosmos.in", 
                            "X-Title": "Ashna XCOSMOS"
                        },
                        body: JSON.stringify({
                            "model": model,
                            "messages": [
                                {"role": "system", "content": SYSTEM_PROMPT},
                                {"role": "user", "content": userText}
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        // Silent Failure - Throw to catch block to trigger next attempt
                        throw new Error(`Status ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if(data.choices && data.choices[0]) {
                        aiText = data.choices[0].message.content;
                        success = true;
                        // Save the working index for next time
                        currentCoreIndex = modelIndex;
                        apiKeyIndex = keyIndex;
                    } else {
                        throw new Error("Invalid Format");
                    }

                } catch (e) {
                    attempts++;
                    // Continue loop to try next model/key
                }
            }

            // AI Done Thinking
            isProcessing = false;

            if (success) {
                updateStatus("ONLINE"); 
                addLog(aiText, 'ashna-msg');
                speak(aiText);
            } else {
                // Only show error if ALL models and ALL keys failed
                updateStatus("NET ERROR");
                addLog(`All routes failed. Check connection.`, 'error-msg');
                speak("I cannot establish a link, Sir.");
                setVisuals(false);
            }
        }

        // ================= SPEECH SYNTHESIS =================
        const synth = window.speechSynthesis;
        let selectedVoice = null;

        function loadVoices() {
            const voices = synth.getVoices();
            // Try to find a good female voice or mobile default
            selectedVoice = voices.find(v => v.name.includes("Google US English")) || 
                           voices.find(v => v.name.includes("Samantha")) || 
                           voices.find(v => v.lang.includes("en-US")) || 
                           voices[0];
        }
        if(synth.onvoiceschanged !== undefined) {
             synth.onvoiceschanged = loadVoices;
        }
        loadVoices(); 

        function speak(text) {
            // FLAG: AI IS SPEAKING (Blocks Mic)
            isAISpeaking = true;
            try { recognition.abort(); } catch(e) {} // Ensure mic is off

            updateStatus("SPEAKING");
            setVisuals(true);

            if (synth.speaking) synth.cancel();

            if (text.length > 300 || text.includes("```")) {
                text = "Data displayed on screen, Boss.";
                if(!isChatOpen) toggleChat();
            }

            const utterance = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
            if(selectedVoice) utterance.voice = selectedVoice;
            utterance.pitch = 1.1; 
            utterance.rate = 1.0; 

            utterance.onend = () => {
                // DONE SPEAKING
                isAISpeaking = false;
                setVisuals(false);
                updateStatus("STANDBY");
                // On mobile, we DO NOT auto-restart mic here to save battery and avoid loops.
                // User must tap to speak again.
            };
            
            utterance.onerror = () => {
                isAISpeaking = false;
                setVisuals(false);
                updateStatus("STANDBY");
            }

            synth.speak(utterance);
        }

        // ================= UTILITIES =================
        function setVisuals(active) {
            const viz = document.getElementById('wave-viz');
            if (active) viz.classList.add('active');
            else viz.classList.remove('active');
        }

        function addLog(text, className) {
            const div = document.createElement('div');
            div.className = `message ${className}`;
            if (text.includes("```")) text = text.replace(/```([\s\S]*?)```/g, "<pre>$1</pre>");
            div.innerHTML = text.replace(/\n/g, "<br>");
            const log = document.getElementById('chat-log');
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            return div.id;
        }

    </script>
</body>
</html>
